name: Host dbt doc on website

on:
  workflow_call:
    inputs:
      # config-path:
      #   required: true
      #   type: string
      env:
        required: true
        type: string

      dbt_project_path:
        required: true
        type: string

    # secrets:
    #   token:
    #     required: true
permissions:
  contents: write

env:
  dbt_model_name_ghaction_metadata: github_actions_metadata
  
jobs:
  # triage:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/labeler@v4
  #     with:
  #       repo-token: ${{ secrets.token }}
  #       configuration-path: ${{ inputs.config-path }}

  build:  
    runs-on: ${{ inputs.env }} # self-hosted # environment to be used
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'
        
      - name: Install dbt
        run: pip install dbt-sqlserver==1.3.0
        
      - name: Install dbt deps
        run: dbt deps
        working-directory: ${{ inputs.dbt_project_path }}

      - name: (Windows) create dbt model (.sql) to document current CI build no.
        if: runner.os == 'Windows'
        run: |
          $dbt_schema = "ghactions"
          # $dbt_model_name = $dbt_model_name_ghaction_metadata
          $output_path = "${{ inputs.dbt_project_path }}/models/$dbt_schema/$dbt_model_name_ghaction_metadata.sql"

          mkdir ${{ inputs.dbt_project_path }}/models/$dbt_schema -Force
          
          $content = echo "
            {{ config(
                materialized='view',
                schema='$dbt_schema',
              ) }}
            select 
              '${{ github.run_number }}' as build_no,
              '${{ github.repositoryUrl }}' as repo_url,
              '${{ github.actor }}' as actor,
              '${{ runner.name }}' as runner_name,
              '${{ runner.os }}' as runner_os
          "
          
          Out-File -FilePath $output_path -InputObject $content -Encoding utf8

          # Convert to UTF-8 No BOM
          $MyFile = Get-Content $output_path
          $Utf8NoBomEncoding = New-Object System.Text.UTF8Encoding $False
          [System.IO.File]::WriteAllLines($output_path, $MyFile, $Utf8NoBomEncoding)

      - name: dbt run ${{ dbt_model_name_ghaction_metadata }}
        if: runner.os == 'Windows'
        run: dbt run --select ${{ dbt_model_name_ghaction_metadata }} --profiles-dir .
        working-directory: ${{ inputs.dbt_project_path }}  

      - name: dbt docs gen
        run: dbt docs generate --profiles-dir .
        working-directory: ${{ inputs.dbt_project_path }}

      - name: dbt compile
        run: dbt compile --profiles-dir .
        working-directory: ${{ inputs.dbt_project_path }}
        
      - name: Upload Artifacts ðŸ”º # The project is then uploaded as an artifact named 'site'.
        uses: actions/upload-artifact@v1
        with:
          name: artifact
          path: ${{ inputs.dbt_project_path }}/target # etl/CDW_FB_SQ
      

  deploy:
    needs: [build]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Download Artifacts ðŸ”» # The built project is downloaded into the 'site' folder.
        uses: actions/download-artifact@v1
        with:
          name: artifact

      # - name: ls 
      #   run: |
      #     ls -R
      
      - name: Deploy
        uses: JamesIves/github-pages-deploy-action@v4
        with: 
          folder: artifact # etl/CDW_FB_SQ/target
